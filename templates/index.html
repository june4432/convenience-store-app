{% extends "base.html" %}

{% block title %}대환장편의점 - 쇼핑{% endblock %}

{% block extra_css %}
<style>
    /* 이벤트 모달 스타일 */
    .event-qr-code-large {
        width: 200px;
        height: 200px;
        background: white;
        border-radius: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #333;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        border: 3px solid #ffc107;
        margin: 0 auto;
    }
    
    .event-qr-code-large:hover {
        transform: scale(1.05);
        box-shadow: 0 12px 24px rgba(0,0,0,0.3);
    }
    
    .event-qr-code-large img {
        width: 100%;
        height: 100%;
        border-radius: 12px;
    }
    
    .event-qr-section {
        background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        border-radius: 15px;
        padding: 30px;
        border: 2px solid #ffc107;
    }
    
    /* 포스 헤더 스타일 */
    .pos-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 10px 0;
        margin-bottom: 20px;
    }
    
    .pos-header p {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 500;
    }
    
    /* 상품 카드 스타일 */
    .product-card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        cursor: pointer;
        border: none;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .product-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    
    .product-card:active {
        transform: translateY(-2px);
    }
    
    /* 장바구니 스타일 */
    .cart-item {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 10px;
        margin-bottom: 10px;
        border-left: 4px solid #28a745;
    }
    
    .price-tag .badge {
        font-size: 1rem;
        padding: 8px 12px;
    }
    
    /* 카테고리 버튼 스타일 */
    .btn-group .btn {
        border-radius: 20px;
        margin: 2px;
        transition: all 0.3s ease;
    }
    
    .btn-group .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .btn-group .btn.active {
        background: linear-gradient(45deg, #667eea, #764ba2);
        border-color: #667eea;
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<!-- 이벤트 모달 -->
<div class="modal fade" id="eventModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">
                    <i class="fas fa-gift me-2"></i>
                    🎰 할인쿠폰 뽑기 이벤트! 🎰
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" onclick="closeEventModal()"></button>
            </div>
            <div class="modal-body text-center">
                <div class="mb-4">
                    <h4 class="text-warning mb-3">
                        <i class="fas fa-star me-2"></i>
                        특별 할인쿠폰 이벤트!
                    </h4>
                    <p class="lead mb-4">
                        1000원~10000원 할인쿠폰을 뽑아보세요!<br>
                        아래 QR코드를 스캔하면 <strong>뽑기 페이지</strong>로 이동합니다!
                    </p>
                </div>
                
                <div class="event-qr-section mb-4">
                    <h6 class="text-muted mb-3">뽑기 페이지로 이동하는 QR코드</h6>
                    <div class="event-qr-container d-inline-block">
                        <div class="event-qr-code-large" id="eventQRCode">
                            <i class="fas fa-qrcode fa-4x text-muted"></i>
                        </div>
                    </div>
                </div>
                
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>이벤트 안내:</strong><br>
                    • QR코드를 스캔하면 뽑기 페이지로 이동합니다<br>
                    • 뽑기 페이지에서 "뽑기 시작!" 버튼을 클릭하세요<br>
                    • 뽑은 쿠폰의 QR코드를 포스기에서 스캔하여 사용하세요
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary w-100" data-bs-dismiss="modal" onclick="closeEventModal()">
                    <i class="fas fa-times me-2"></i>닫기
                </button>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid h-100">
    <div class="row h-100">
        <!-- 왼쪽: 상품 목록 -->
        <div class="col-md-8 h-100">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-shopping-basket"></i> 상품 목록
                    </h4>
                </div>
                <div class="card-body p-0">
                    <!-- 카테고리 필터 -->
                    <div class="p-3 border-bottom">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-primary active" data-category="all">전체</button>
                            {% for category in categories %}
                            <button type="button" class="btn btn-outline-primary" data-category="{{ category.name }}">
                                <i class="{{ category.icon }} {{ category.color }} me-1"></i>{{ category.name }}
                            </button>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- 상품 그리드 -->
                    <div class="p-3">
                        <div class="row" id="products-container">
                            {% for product in products %}
                            <div class="col-md-4 col-lg-3 mb-3 product-item" data-category="{{ product.category }}">
                                <div class="card h-100 product-card" data-product-id="{{ product.id }}"
                                                data-product-name="{{ product.name }}"
                                                data-product-price="{{ product.price }}">
                                    <div class="card-body text-center p-3">
                                        <!-- 상품 이미지 -->
                                        <div class="product-image">
                                            {% if product.image_url %}
                                                <div class="image-container">
                                                    <img src="{{ product.image_url }}" alt="{{ product.name }}" class="product-img">
                                                </div>
                                            {% else %}
                                                <div class="image-container">
                                                    <div class="product-icon">
                                                        {% if product.category == '음식' %}
                                                            <i class="fas fa-utensils fa-2x text-warning"></i>
                                                        {% elif product.category == '음료' %}
                                                            <i class="fas fa-coffee fa-2x text-info"></i>
                                                        {% elif product.category == '간식' %}
                                                            <i class="fas fa-cookie-bite fa-2x text-success"></i>
                                                        {% else %}
                                                            <i class="fas fa-box fa-2x text-secondary"></i>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            {% endif %}
                                        </div>
                                        <h6 class="card-title mb-2">{{ product.name }}</h6>
                                        {% if product.description %}
                                            <p class="card-text text-muted small mb-2">{{ product.description[:50] }}{% if product.description|length > 50 %}...{% endif %}</p>
                                        {% endif %}
                                        <div class="price-tag mb-2">
                                            <span class="badge bg-primary fs-6">{{ "{:,.0f}".format(product.price) }}원</span>
                                        </div>
                                        <div class="stock-info mb-2">
                                            <small class="text-muted">재고: {{ product.stock }}개</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 오른쪽: 장바구니 -->
        <div class="col-md-4 h-100">
            <div class="card h-100">
                <div class="card-header bg-success text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">
                            <i class="fas fa-shopping-cart"></i> 장바구니
                        </h4>
                        <button class="btn btn-sm btn-outline-warning" onclick="openEventModal()" id="eventToggleBtn" style="border-color: #ffc107; color: #ffc107;">
                            <i class="fas fa-gift"></i> 이벤트
                        </button>
                    </div>
                </div>
                <div class="card-body p-0 d-flex flex-column">
                    <!-- 장바구니 아이템 목록 -->
                    <div class="flex-grow-1 p-3" id="cart-items-container">
                        <div id="cart-items">
                            <!-- 장바구니 아이템들이 여기에 동적으로 추가됩니다 -->
                        </div>
                        <div id="empty-cart" class="text-center text-muted py-5">
                            <i class="fas fa-shopping-cart fa-3x mb-3"></i>
                            <p>장바구니가 비어있습니다</p>
                        </div>
                    </div>
                    
                    <!-- 장바구니 요약 -->
                    <div class="border-top p-3">
                        <!-- 쿠폰 섹션 -->
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="text-muted">쿠폰 할인:</span>
                                <span id="coupon-discount">0원</span>
                            </div>
                            <div id="coupon-buttons">
                                <button class="btn btn-outline-primary btn-sm w-100" onclick="openQRScanner()">
                                    <i class="fas fa-qrcode me-1"></i>QR코드 쿠폰 스캔
                                </button>
                            </div>
                        </div>
                        
                        <div class="row mb-2">
                            <div class="col-6">총 수량:</div>
                            <div class="col-6 text-end" id="total-quantity">0개</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-6">할인 전 총액:</div>
                            <div class="col-6 text-end" id="subtotal-amount">0원</div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-6"><strong>최종 금액:</strong></div>
                            <div class="col-6 text-end"><strong id="total-amount">0원</strong></div>
                        </div>
                        <div class="d-grid gap-2">
                            <!-- 커스텀 결제 버튼 추가 -->
                            <button class="btn btn-warning mt-2" id="custompay-btn" disabled>
                                <i class="fas fa-qrcode"></i> QR코드 결제
                            </button>
                            <button class="btn btn-primary" id="checkout-btn" disabled>
                                <i class="fas fa-credit-card"></i> 토스페이먼츠로 결제하기
                            </button>
                            <button class="btn btn-outline-secondary" id="clear-cart-btn" disabled>
                                <i class="fas fa-trash"></i> 장바구니 비우기
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 결제 결과 모달 -->
<div class="modal fade" id="paymentResultModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" id="resultModalHeader">
                <h5 class="modal-title" id="resultModalTitle">결제 결과</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center" id="resultModalBody">
                <!-- 결과 내용이 여기에 동적으로 추가됩니다 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="closePaymentResult()">
                    확인
                </button>
                <button type="button" class="btn btn-outline-success" onclick="playModalSound()">
                    <i class="fas fa-volume-up me-1"></i>소리 재생
                </button>
            </div>
        </div>
    </div>
</div>

<!-- QR코드 스캔 모달 -->
<div class="modal fade" id="qrScannerModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-qrcode me-2"></i>QR코드 쿠폰 스캔
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" onclick="closeQRScanner()"></button>
            </div>
            <div class="modal-body text-center">
                <div class="mb-3">
                    <p class="text-muted">QR코드를 카메라에 비춰주세요</p>
                </div>
                <div class="position-relative">
                    <video id="qrVideo" class="w-100" style="max-width: 400px; border-radius: 10px;"></video>
                    <canvas id="qrCanvas" style="display: none;"></canvas>
                    <div id="qrOverlay" class="position-absolute" style="top: 0; left: 0; right: 0; bottom: 0; pointer-events: none;">
                        <div class="border border-success" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 200px; height: 200px; border-radius: 10px;"></div>
                    </div>
                </div>
                <div class="mt-3">
                    <button class="btn btn-success" onclick="startQRScanner()">
                        <i class="fas fa-camera me-1"></i>카메라 시작
                    </button>
                    <button class="btn btn-secondary ms-2" onclick="stopQRScanner()">
                        <i class="fas fa-stop me-1"></i>카메라 중지
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 커스텀 결제 QR코드 모달 -->
<div class="modal fade" id="custompayModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title"><i class="fas fa-qrcode me-2"></i>QR코드로 결제하기ㅇ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <div id="custompay-qr-container">
                    <div class="mb-2">아래 QR코드를 고객이 스캔하여 결제를 진행하세요.</div>
                    <div id="custompay-qr" class="mb-3"><i class="fas fa-spinner fa-spin fa-3x text-muted"></i></div>
                    <div id="custompay-status" class="mt-2"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary w-100" data-bs-dismiss="modal">닫기</button>
            </div>
        </div>
    </div>
</div>

<!-- 로딩 오버레이 -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="text-center">
        <div class="loading-spinner"></div>
        <div class="loading-text">상품을 장바구니에 추가하는 중...</div>
        <div class="progress-container">
            <div class="progress-bar" id="progressBar"></div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<!-- 토스페이먼츠 SDK -->
<script src="https://js.tosspayments.com/v2/standard"></script>

<!-- QR코드 스캔 라이브러리 -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

<script>
// 전역 변수
let cart = {};
const products = {{ products_data|tojson }};
let audioContextInitialized = false; // iOS Safari 오디오 컨텍스트 초기화 상태
let currentCoupon = null; // 현재 적용된 쿠폰
let qrStream = null; // QR 스캔 스트림
let custompayPolling = null;

// 페이지 로드 시 초기화
document.addEventListener('DOMContentLoaded', function() {
    loadCartFromSession();
    updateCartDisplay();
    setupEventListeners();
    checkPaymentResult(); // 결제 결과 확인
    
    // iOS Safari용 사용자 상호작용 감지
    setupIOSAudioSupport();

    document.getElementById('custompay-btn').addEventListener('click', function() {
        openCustomPayModal();
    });
});

// 이벤트 리스너 설정
function setupEventListeners() {
    // 상품 카드 클릭 이벤트 (카테고리 필터링 방지)
    document.querySelectorAll('.product-card').forEach(card => {
        card.addEventListener('click', function(e) {
            e.preventDefault(); // Prevent default link behavior if any
            e.stopPropagation(); // Stop event propagation

            const productId = card.dataset.productId;
            const productName = card.dataset.productName;
            const productPrice = parseInt(card.dataset.productPrice);
            addToCart(productId, productName, productPrice);
        });
    });
    
    // 카테고리 필터
    document.querySelectorAll('.btn-group button[data-category]').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault(); // 기본 동작 방지
            const category = this.dataset.category;
            filterProducts(category);
            
            // 활성 버튼 변경
            document.querySelectorAll('[data-category]').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
        });
    });
    
    // 결제 버튼
    document.getElementById('checkout-btn').addEventListener('click', function() {
        if (Object.keys(cart).length > 0) {
            // 바로 토스페이먼츠 결제창 열기
            proceedToPayment();
        }
    });
    
    // 장바구니 비우기 버튼
    document.getElementById('clear-cart-btn').addEventListener('click', function() {
        if (confirm('장바구니를 비우시겠습니까?')) {
            clearCart();
        }
    });
}

// 상품 필터링
function filterProducts(category) {
    const products = document.querySelectorAll('.product-item');
    products.forEach(product => {
        if (category === 'all' || product.dataset.category === category) {
            product.style.display = 'block';
        } else {
            product.style.display = 'none';
        }
    });
}

// 장바구니에 상품 추가
function addToCart(productId, productName, productPrice) {
    // 로딩 애니메이션 시작
    showLoadingAnimation();
    
    // 숫자로 변환하여 안전하게 처리 (정수로 변환)
    const price = Math.floor(parseFloat(productPrice)) || 0;
    
    if (cart[productId]) {
        cart[productId].quantity += 1;
    } else {
        cart[productId] = {
            name: productName,
            price: price,
            quantity: 1
        };
    }
    
    // 프로그레스바 시뮬레이션
    simulateProgress(() => {
        // 세션에 저장
        saveCartToSession();
        updateCartDisplay();
        
        // 시각적 피드백
        showAddToCartFeedback(productName);
        
        // 로딩 애니메이션 종료
        hideLoadingAnimation();
    });
}

// 장바구니에서 상품 제거
function removeFromCart(productId) {
    if (confirm('정말로 이 상품을 장바구니에서 삭제하시겠습니까?')) {
        delete cart[productId];
        saveCartToSession();
        updateCartDisplay();
    }
}

// 장바구니 아이템 수량 업데이트
function updateCartItemQuantity(productId, change) {
    if (cart[productId]) {
        cart[productId].quantity += change;
        if (cart[productId].quantity <= 0) {
            delete cart[productId];
        }
        saveCartToSession();
        updateCartDisplay();
    }
}

// 장바구니 비우기
function clearCart() {
    cart = {};
    // 쿠폰도 함께 취소
    if (currentCoupon) {
        currentCoupon = null;
        showToast('장바구니와 쿠폰이 모두 비워졌습니다.', 'info');
    } else {
        showToast('장바구니가 비워졌습니다.', 'info');
    }
    saveCartToSession();
    updateCartDisplay();
}

// 장바구니 표시 업데이트
function updateCartDisplay() {
    const cartContainer = document.getElementById('cart-items');
    const emptyCart = document.getElementById('empty-cart');
    const checkoutBtn = document.getElementById('checkout-btn');
    const clearCartBtn = document.getElementById('clear-cart-btn');
    
    let totalQuantity = 0;
    let totalAmount = 0;
    
    if (Object.keys(cart).length === 0) {
        cartContainer.innerHTML = '';
        emptyCart.style.display = 'block';
        checkoutBtn.disabled = true;
        clearCartBtn.disabled = true;
    } else {
        emptyCart.style.display = 'none';
        checkoutBtn.disabled = false;
        clearCartBtn.disabled = false;
        
        let cartHTML = '';
        
        for (const [productId, item] of Object.entries(cart)) {
            // 안전한 숫자 변환 (정수로 변환)
            const price = Math.floor(parseFloat(item.price)) || 0;
            const quantity = parseInt(item.quantity) || 0;
            const itemTotal = price * quantity;
            
            totalQuantity += quantity;
            totalAmount += itemTotal;
            
            cartHTML += `
                <div class="cart-item border-bottom pb-2 mb-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="mb-1">${item.name || '상품명 없음'}</h6>
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">${price.toLocaleString()}원</small>
                                <div class="input-group input-group-sm w-50">
                                    <button class="btn btn-outline-secondary" type="button" onclick="updateCartItemQuantity(${productId}, -1)">-</button>
                                    <input type="text" class="form-control text-center" value="${quantity}" readonly>
                                    <button class="btn btn-outline-secondary" type="button" onclick="updateCartItemQuantity(${productId}, 1)">+</button>
                                </div>
                                <strong>${itemTotal.toLocaleString()}원</strong>
                            </div>
                        </div>
                        <div class="ms-2">
                            <button class="btn btn-sm btn-outline-danger" onclick="removeFromCart(${productId})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        cartContainer.innerHTML = cartHTML;
    }
    
    // 쿠폰 할인 계산
    let discountAmount = 0;
    let discountInfo = '';
    
    if (currentCoupon) {
        if (currentCoupon.type === 'percent') {
            discountAmount = Math.floor(totalAmount * (currentCoupon.discount / 100));
            discountInfo = `${currentCoupon.discount}% 할인`;
        } else {
            discountAmount = Math.min(currentCoupon.discount, totalAmount);
            discountInfo = `${currentCoupon.discount.toLocaleString()}원 할인`;
        }
    }
    
    const finalAmount = totalAmount - discountAmount;
    
    // 총계 업데이트
    document.getElementById('total-quantity').textContent = `${totalQuantity}개`;
    document.getElementById('subtotal-amount').textContent = `${totalAmount.toLocaleString()}원`;
    document.getElementById('total-amount').textContent = `${finalAmount.toLocaleString()}원`;
    document.getElementById('coupon-discount').textContent = `${discountAmount.toLocaleString()}원`;
    
    // 쿠폰이 적용된 경우 할인 금액 표시 스타일 변경
    const couponDiscountElement = document.getElementById('coupon-discount');
    const couponButtonsElement = document.getElementById('coupon-buttons');
    
    if (discountAmount > 0) {
        couponDiscountElement.className = 'text-success fw-bold';
        couponDiscountElement.textContent = `-${discountAmount.toLocaleString()}원`;
        
        // 할인 정보 표시
        const discountInfoElement = document.createElement('small');
        discountInfoElement.className = 'text-success d-block';
        const couponDescription = currentCoupon.description || `${currentCoupon.discount}${currentCoupon.type === 'fixed' ? '원' : '%'} 할인 쿠폰`;
        discountInfoElement.textContent = `${couponDescription} (${discountInfo})`;
        couponDiscountElement.appendChild(discountInfoElement);
        
        // 쿠폰 버튼 업데이트 (취소 버튼 추가)
        couponButtonsElement.innerHTML = `
            <div class="d-flex gap-2">
                <button class="btn btn-outline-primary btn-sm flex-grow-1" onclick="openQRScanner()">
                    <i class="fas fa-qrcode me-1"></i>새 쿠폰 스캔
                </button>
                <button class="btn btn-outline-danger btn-sm" onclick="cancelCoupon()" title="쿠폰 취소">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
    } else {
        couponDiscountElement.className = '';
        couponDiscountElement.textContent = '0원';
        
        // 쿠폰 버튼 원래대로 복원
        couponButtonsElement.innerHTML = `
            <button class="btn btn-outline-primary btn-sm w-100" onclick="openQRScanner()">
                <i class="fas fa-qrcode me-1"></i>QR코드 쿠폰 스캔
            </button>
        `;
    }
    // 커스텀 결제 버튼 상태도 업데이트
    updateCustomPayButton();
}

// 세션에 장바구니 저장
function saveCartToSession() {
    fetch('/save_cart', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(cart)
    });
}

// 세션에서 장바구니 로드
function loadCartFromSession() {
    fetch('/load_cart')
        .then(response => response.json())
        .then(data => {
            if (data.cart && typeof data.cart === 'object') {
                // 데이터 검증 및 정리
                const validatedCart = {};
                for (const [productId, item] of Object.entries(data.cart)) {
                    if (item && typeof item === 'object') {
                        validatedCart[productId] = {
                            name: item.name || '상품명 없음',
                            price: Math.floor(parseFloat(item.price)) || 0,
                            quantity: parseInt(item.quantity) || 0
                        };
                    }
                }
                cart = validatedCart;
                updateCartDisplay();
            }
        })
        .catch(error => {
            console.error('장바구니 로드 오류:', error);
            cart = {};
            updateCartDisplay();
        });
}

// 장바구니 추가 피드백
function showAddToCartFeedback(productName) {
    // 토스트 메시지 또는 간단한 알림
    const toast = document.createElement('div');
    toast.className = 'position-fixed top-0 end-0 p-3';
    toast.style.zIndex = '1050';
    toast.innerHTML = `
        <div class="toast show" role="alert">
            <div class="toast-header">
                <i class="fas fa-check-circle text-success me-2"></i>
                <strong class="me-auto">장바구니 추가</strong>
                <button type="button" class="btn-close" onclick="this.parentElement.parentElement.parentElement.remove()"></button>
            </div>
            <div class="toast-body">
                ${productName}이(가) 장바구니에 추가되었습니다.
            </div>
        </div>
    `;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        if (toast.parentElement) {
            toast.remove();
        }
    }, 3000);
}

// 결제 진행
function proceedToPayment() {
    // 기본 고객 정보 사용
    const formData = new FormData();
    formData.append('customer_name', '고객');
    formData.append('customer_phone', '010-0000-0000');
    formData.append('customer_email', 'customer@example.com');
    
    // 결제 요청
    fetch('/payment/request', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // 결제창 열기
            const tossPayments = TossPayments(data.client_key);
            const payment = tossPayments.payment({ customerKey: data.client_key });
            
            payment.requestPayment({
                method: "CARD",
                amount: {
                    currency: "KRW",
                    value: data.payment_data.amount.value
                },
                orderId: data.payment_data.orderId,
                orderName: data.payment_data.orderName,
                customerName: data.payment_data.customerName,
                customerEmail: data.payment_data.customerEmail,
                successUrl: data.payment_data.successUrl,
                failUrl: data.payment_data.failUrl,
                card: {
                    useEscrow: false,
                    flowMode: "DEFAULT",
                    useCardPoint: false,
                    useAppCardOnly: false,
                },
            });
        } else {
            alert('결제 요청에 실패했습니다: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('결제 요청 중 오류가 발생했습니다.');
    });
}

// 결제 결과 모달 표시
function showPaymentResult(success, message, orderId = null) {
    const modal = new bootstrap.Modal(document.getElementById('paymentResultModal'));
    const header = document.getElementById('resultModalHeader');
    const title = document.getElementById('resultModalTitle');
    const body = document.getElementById('resultModalBody');
    
    if (success) {
        // 성공 모달
        header.className = 'modal-header bg-success text-white';
        title.textContent = '결제 완료';
        body.innerHTML = `
            <div class="py-4">
                <i class="fas fa-check-circle text-success fa-4x mb-3"></i>
                <h4 class="text-success mb-3">결제가 성공적으로 완료되었습니다!</h4>
                <p class="mb-2">주문번호: <strong>${orderId || 'N/A'}</strong></p>
                <p class="text-muted">감사합니다.</p>
                <div class="alert alert-info mt-3">
                    <i class="fas fa-volume-up me-2"></i>
                    <strong>소리 재생 안내:</strong><br>
                    아래 버튼을 터치하면 소리가 재생됩니다! 🎵
                </div>
            </div>
        `;
        
        // iOS Safari용 지연된 소리 재생
        setTimeout(() => {
            playSuccessSound();
        }, 500);
    } else {
        // 실패 모달
        header.className = 'modal-header bg-danger text-white';
        title.textContent = '결제 실패';
        body.innerHTML = `
            <div class="py-4">
                <i class="fas fa-times-circle text-danger fa-4x mb-3"></i>
                <h4 class="text-danger mb-3">결제에 실패했습니다</h4>
                <p class="mb-2">${message}</p>
                <p class="text-muted">다시 시도해주세요.</p>
                <div class="alert alert-info mt-3">
                    <i class="fas fa-volume-up me-2"></i>
                    <strong>소리 재생 안내:</strong><br>
                    아래 버튼을 터치하면 소리가 재생됩니다! 🎵
                </div>
            </div>
        `;
        
        // iOS Safari용 지연된 소리 재생
        setTimeout(() => {
            playFailSound();
        }, 500);
    }
    
    modal.show();
    
    // iOS Safari에서 모달이 완전히 표시된 후 오디오 컨텍스트 초기화
    setTimeout(() => {
        initializeAudioContext();
    }, 1000);
}

// iOS Safari용 오디오 컨텍스트 초기화
function initializeAudioContext() {
    const userAgent = navigator.userAgent.toLowerCase();
    const isIOS = /iphone|ipad|ipod/.test(userAgent);
    const isSafari = /safari/.test(userAgent) && !/chrome/.test(userAgent);
    
    if (isIOS && isSafari) {
        console.log('iOS Safari 오디오 컨텍스트 초기화 시도');
        
        // 모달 내부에 터치 이벤트 추가
        const modalBody = document.getElementById('resultModalBody');
        if (modalBody) {
            modalBody.addEventListener('touchstart', function() {
                console.log('모달 내 터치 감지, 오디오 컨텍스트 초기화');
                audioContextInitialized = true;
                
                // 오디오 컨텍스트 생성 및 재생
                try {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    const audioContext = new AudioContext();
                    if (audioContext.state === 'suspended') {
                        audioContext.resume();
                    }
                    console.log('오디오 컨텍스트 초기화 완료');
                } catch (error) {
                    console.log('오디오 컨텍스트 초기화 실패:', error);
                }
            }, { once: true });
        }
    }
}

// 성공 소리 재생
function playSuccessSound() {
    console.log('성공 소리 재생 시작');
    // 먼저 업로드된 오디오 파일이 있는지 확인
    fetch('/audio/success_list')
        .then(res => res.json())
        .then(data => {
            if (data.success_list && data.success_list.length > 0) {
                const randomUrl = data.success_list[Math.floor(Math.random() * data.success_list.length)];
                playAudioFile(randomUrl);
            } else {
                playBeepSound(800, 200, 'sine');
            }
        });
}

// 실패 소리 재생
function playFailSound() {
    console.log('실패 소리 재생 시작');
    // 먼저 업로드된 오디오 파일이 있는지 확인
    fetch('/admin/audio/settings')
        .then(response => response.json())
        .then(data => {
            console.log('오디오 설정 조회 결과:', data);
            if (data.fail_audio_url) {
                console.log('업로드된 실패 소리 파일 재생:', data.fail_audio_url);
                // 업로드된 오디오 파일 재생
                playAudioFile(data.fail_audio_url);
            } else {
                console.log('업로드된 실패 소리 없음, 기본 비프음 재생');
                // 기본 비프음 재생
                playBeepSound(400, 300, 'sawtooth');
            }
        })
        .catch(error => {
            console.log('오디오 설정 조회 실패:', error);
            // 기본 비프음 재생
            playBeepSound(400, 300, 'sawtooth');
        });
}

// 오디오 파일 재생
function playAudioFile(audioUrl) {
    console.log('오디오 파일 재생 시도:', audioUrl);
    try {
        const audio = new Audio(audioUrl);
        audio.volume = 0.7; // 볼륨 설정
        audio.preload = 'auto'; // 미리 로드
        console.log('오디오 객체 생성 완료, 재생 시작');
        
        // iOS Safari 호환성을 위한 설정
        audio.setAttribute('playsinline', 'true');
        audio.setAttribute('webkit-playsinline', 'true');
        
        // 사용자 상호작용 확인
        const playPromise = audio.play();
        
        if (playPromise !== undefined) {
            playPromise.then(() => {
                console.log('오디오 파일 재생 성공');
            }).catch(error => {
                console.log('오디오 파일 재생 실패:', error);
                // iOS Safari에서 자동 재생이 차단된 경우
                if (error.name === 'NotAllowedError') {
                    console.log('iOS Safari 자동 재생 차단됨, 사용자 상호작용 필요');
                    // 사용자에게 알림
                    showAudioPermissionAlert();
                }
                // 실패 시 기본 비프음 재생
                if (audioUrl.includes('success')) {
                    playBeepSound(800, 200, 'sine');
                } else {
                    playBeepSound(400, 300, 'sawtooth');
                }
            });
        }
    } catch (error) {
        console.log('오디오 파일 재생 중 오류:', error);
    }
}

// iOS Safari 자동 재생 차단 알림
function showAudioPermissionAlert() {
    // 토스트 메시지로 알림
    const toast = document.createElement('div');
    toast.className = 'toast align-items-center text-white bg-warning border-0 position-fixed';
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999;';
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-volume-up me-2"></i>
                <strong>소리 재생 안내:</strong><br>
                iOS에서는 화면을 터치한 후 소리가 재생됩니다.
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    document.body.appendChild(toast);
    
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    setTimeout(() => {
        if (toast.parentElement) {
            toast.remove();
        }
    }, 5000);
}

// 비프음 생성 및 재생 (기본 소리)
function playBeepSound(frequency, duration, type = 'sine') {
    try {
        // iOS Safari 호환성을 위한 오디오 컨텍스트 생성
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioContext = new AudioContext();
        
        // iOS Safari에서 오디오 컨텍스트가 일시정지된 상태일 수 있음
        if (audioContext.state === 'suspended') {
            audioContext.resume();
        }
        
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = frequency;
        oscillator.type = type;
        
        // 페이드 인/아웃 효과
        gainNode.gain.setValueAtTime(0, audioContext.currentTime);
        gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.01);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration / 1000);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + duration / 1000);
        
    } catch (error) {
        console.log('소리 재생 실패:', error);
        // iOS Safari에서 Web Audio API가 지원되지 않는 경우
        if (error.name === 'NotSupportedError') {
            console.log('Web Audio API 지원되지 않음');
        }
    }
}

// 결제 결과 모달 닫기
function closePaymentResult() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('paymentResultModal'));
    if (modal) {
        modal.hide();
    }
    
    // 성공 시 장바구니 비우기
    if (document.getElementById('resultModalHeader').classList.contains('bg-success')) {
        clearCart();
    }
    
    // URL 파라미터 정리 (결제 관련 파라미터 제거)
    const url = new URL(window.location);
    const paramsToRemove = ['paymentKey', 'orderId', 'amount', 'success', 'code', 'message'];
    paramsToRemove.forEach(param => url.searchParams.delete(param));
    
    // 히스토리 업데이트 (페이지 새로고침 없이 URL 변경)
    window.history.replaceState({}, '', url);
}

// 로딩 애니메이션 표시
function showLoadingAnimation() {
    const overlay = document.getElementById('loadingOverlay');
    const progressBar = document.getElementById('progressBar');
    
    overlay.style.display = 'flex';
    progressBar.style.width = '0%';
}

// 로딩 애니메이션 숨기기
function hideLoadingAnimation() {
    const overlay = document.getElementById('loadingOverlay');
    overlay.style.display = 'none';
}

// 프로그레스바 시뮬레이션
function simulateProgress(callback) {
    const progressBar = document.getElementById('progressBar');
    let progress = 0;
    
    const interval = setInterval(() => {
        progress += Math.random() * 15 + 5; // 5-20%씩 증가
        
        if (progress >= 100) {
            progress = 100;
            clearInterval(interval);
            
            // 완료 후 약간의 지연을 두고 콜백 실행
            setTimeout(callback, 300);
        }
        
        progressBar.style.width = progress + '%';
    }, 20);
}

// URL 파라미터에서 결제 결과 확인
function checkPaymentResult() {
    const urlParams = new URLSearchParams(window.location.search);
    const paymentKey = urlParams.get('paymentKey');
    const orderId = urlParams.get('orderId');
    const amount = urlParams.get('amount');
    const success = urlParams.get('success');
    const errorCode = urlParams.get('code');
    const errorMessage = urlParams.get('message');
    
    if (paymentKey && orderId && amount) {
        // 결제 성공 처리
        processPaymentSuccess(paymentKey, orderId, amount);
    } else if (errorCode || errorMessage) {
        // 결제 실패 처리
        showPaymentResult(false, errorMessage || `오류 코드: ${errorCode}`);
    }
}

// 결제 성공 처리
function processPaymentSuccess(paymentKey, orderId, amount) {
    // 서버에 결제 승인 요청
    fetch('/payment/success', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            paymentKey: paymentKey,
            orderId: orderId,
            amount: amount
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showPaymentResult(true, '결제가 완료되었습니다.', orderId);
        } else {
            showPaymentResult(false, data.message || '결제 처리 중 오류가 발생했습니다.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showPaymentResult(false, '결제 처리 중 오류가 발생했습니다.');
    });
}

// iOS Safari 오디오 지원 설정
function setupIOSAudioSupport() {
    const userAgent = navigator.userAgent.toLowerCase();
    const isIOS = /iphone|ipad|ipod/.test(userAgent);
    const isSafari = /safari/.test(userAgent) && !/chrome/.test(userAgent);
    
    if (isIOS && isSafari) {
        console.log('iOS Safari 감지됨, 오디오 지원 설정');
        
        // 사용자 상호작용 시 오디오 컨텍스트 초기화
        const initAudioOnInteraction = () => {
            if (!audioContextInitialized) {
                console.log('사용자 상호작용 감지, 오디오 컨텍스트 초기화');
                audioContextInitialized = true;
                
                // 이벤트 리스너 제거
                document.removeEventListener('touchstart', initAudioOnInteraction);
                document.removeEventListener('click', initAudioOnInteraction);
            }
        };
        
        // 터치와 클릭 이벤트 감지
        document.addEventListener('touchstart', initAudioOnInteraction, { once: true });
        document.addEventListener('click', initAudioOnInteraction, { once: true });
    }
}

// 모달에서 소리 재생 버튼 클릭 시
function playModalSound() {
    console.log('모달 소리 재생 버튼 클릭');
    
    // 현재 모달의 상태 확인
    const header = document.getElementById('resultModalHeader');
    const isSuccess = header.classList.contains('bg-success');
    
    if (isSuccess) {
        console.log('성공 소리 재생');
        playSuccessSound();
    } else {
        console.log('실패 소리 재생');
        playFailSound();
    }
}

// QR코드 스캔 모달 열기
function openQRScanner() {
    const modal = new bootstrap.Modal(document.getElementById('qrScannerModal'));
    modal.show();
}

// QR코드 스캔 모달 닫기
function closeQRScanner() {
    stopQRScanner();
    const modal = bootstrap.Modal.getInstance(document.getElementById('qrScannerModal'));
    if (modal) {
        modal.hide();
    }
}

// QR코드 스캔 시작
async function startQRScanner() {
    try {
        const video = document.getElementById('qrVideo');
        const canvas = document.getElementById('qrCanvas');
        const ctx = canvas.getContext('2d');
        
        console.log('=== 카메라 디버깅 시작 ===');
        console.log('navigator.mediaDevices:', navigator.mediaDevices);
        console.log('getUserMedia 지원:', !!navigator.mediaDevices.getUserMedia);
        
        // 사용 가능한 미디어 장치 확인
        if (navigator.mediaDevices && navigator.mediaDevices.enumerateDevices) {
            const devices = await navigator.mediaDevices.enumerateDevices();
            const videoDevices = devices.filter(device => device.kind === 'videoinput');
            console.log('사용 가능한 비디오 장치:', videoDevices);
        }
        
        // iOS Safari 호환성을 위한 설정
        const constraints = {
            video: {
                facingMode: 'environment', // 후면 카메라 우선
                width: { ideal: 640, max: 1280 },
                height: { ideal: 480, max: 720 }
            }
        };
        
        console.log('카메라 제약 조건:', constraints);
        
        // iOS Safari에서 autoplay 문제 해결
        video.setAttribute('playsinline', 'true');
        video.setAttribute('webkit-playsinline', 'true');
        video.muted = true;
        video.autoplay = true;
        
        console.log('카메라 권한 요청 중...');
        
        // 카메라 접근
        qrStream = await navigator.mediaDevices.getUserMedia(constraints);
        
        console.log('카메라 접근 성공!');
        console.log('스트림 정보:', qrStream);
        console.log('비디오 트랙:', qrStream.getVideoTracks());
        
        video.srcObject = qrStream;
        
        // 비디오 이벤트 리스너 추가
        video.addEventListener('loadstart', () => console.log('비디오 로드 시작'));
        video.addEventListener('loadeddata', () => console.log('비디오 데이터 로드 완료'));
        video.addEventListener('canplay', () => console.log('비디오 재생 가능'));
        video.addEventListener('playing', () => console.log('비디오 재생 중'));
        video.addEventListener('error', (e) => console.error('비디오 에러:', e));
        
        // iOS Safari에서 비디오 로드 대기
        video.addEventListener('loadedmetadata', function() {
            console.log('비디오 메타데이터 로드 완료');
            console.log('비디오 크기:', video.videoWidth, 'x', video.videoHeight);
            
            video.play().then(() => {
                console.log('비디오 재생 시작 성공');
                startQRScanLoop();
            }).catch(e => {
                console.error('비디오 재생 실패:', e);
                showCameraError('비디오 재생에 실패했습니다. 페이지를 새로고침해주세요.');
            });
        });
        
    } catch (error) {
        console.error('카메라 접근 실패:', error);
        console.error('에러 이름:', error.name);
        console.error('에러 메시지:', error.message);
        showCameraError(error);
    }
}

// QR코드 스캔 루프 시작
function startQRScanLoop() {
    const video = document.getElementById('qrVideo');
    const canvas = document.getElementById('qrCanvas');
    const ctx = canvas.getContext('2d');
    
    function scanQR() {
        if (video.readyState === video.HAVE_ENOUGH_DATA && video.videoWidth > 0) {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height);
            
            if (code) {
                console.log('QR코드 감지:', code.data);
                processQRCode(code.data);
                stopQRScanner();
                closeQRScanner();
                return;
            }
        }
        requestAnimationFrame(scanQR);
    }
    
    scanQR();
}

// 카메라 에러 표시
function showCameraError(error) {
    let message = '카메라에 접근할 수 없습니다.';
    let isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    
    if (error.name === 'NotAllowedError') {
        message = '카메라 권한이 거부되었습니다. 브라우저 설정에서 카메라 권한을 허용해주세요.';
    } else if (error.name === 'NotFoundError') {
        message = '카메라를 찾을 수 없습니다. 카메라가 연결되어 있는지 확인해주세요.';
    } else if (error.name === 'NotSupportedError') {
        message = '이 브라우저는 카메라 접근을 지원하지 않습니다.';
    } else if (error.name === 'NotReadableError') {
        message = '카메라가 다른 앱에서 사용 중입니다. 다른 앱을 종료하고 다시 시도해주세요.';
    }
    
    // 모달에 에러 메시지 표시
    const modalBody = document.querySelector('#qrScannerModal .modal-body');
    modalBody.innerHTML = `
        <div class="text-center">
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>카메라 접근 오류</strong>
            </div>
            <p class="text-muted">${message}</p>
            <div class="mt-3">
                <button class="btn btn-primary" onclick="retryCameraAccess()">
                    <i class="fas fa-redo me-1"></i>다시 시도
                </button>
                <button class="btn btn-secondary ms-2" onclick="closeQRScanner()">
                    <i class="fas fa-times me-1"></i>닫기
                </button>
            </div>
            <div class="mt-3">
                <small class="text-muted">
                    <strong>iOS Safari 사용자:</strong><br>
                    1. 설정 → Safari → 카메라 → "허용" 선택<br>
                    2. 또는 설정 → 개인정보 보호 및 보안 → 카메라 → Safari 허용<br>
                    3. Safari 완전 종료 후 다시 시작
                </small>
            </div>
            ${isIOS ? `
            <div class="mt-3">
                <div class="alert alert-info">
                    <strong>iOS Safari 대안 방법:</strong><br>
                    <button class="btn btn-outline-primary btn-sm mt-2" onclick="showManualQRInput()">
                        <i class="fas fa-keyboard me-1"></i>수동으로 쿠폰 코드 입력
                    </button>
                </div>
            </div>
            ` : ''}
        </div>
    `;
}

// 카메라 접근 다시 시도
function retryCameraAccess() {
    // 모달 내용을 원래대로 복원
    const modalBody = document.querySelector('#qrScannerModal .modal-body');
    modalBody.innerHTML = `
        <div class="mb-3">
            <p class="text-muted">QR코드를 카메라에 비춰주세요</p>
        </div>
        <div class="position-relative">
            <video id="qrVideo" class="w-100" style="max-width: 400px; border-radius: 10px;"></video>
            <canvas id="qrCanvas" style="display: none;"></canvas>
            <div id="qrOverlay" class="position-absolute" style="top: 0; left: 0; right: 0; bottom: 0; pointer-events: none;">
                <div class="border border-success" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 200px; height: 200px; border-radius: 10px;"></div>
            </div>
        </div>
        <div class="mt-3">
            <button class="btn btn-success" onclick="startQRScanner()">
                <i class="fas fa-camera me-1"></i>카메라 시작
            </button>
            <button class="btn btn-secondary ms-2" onclick="stopQRScanner()">
                <i class="fas fa-stop me-1"></i>카메라 중지
            </button>
        </div>
    `;
    
    // 잠시 후 카메라 다시 시작
    setTimeout(() => {
        startQRScanner();
    }, 500);
}

// 수동 쿠폰 입력 표시
function showManualQRInput() {
    const modalBody = document.querySelector('#qrScannerModal .modal-body');
    modalBody.innerHTML = `
        <div class="text-center">
            <h6>수동 쿠폰 코드 입력</h6>
            <p class="text-muted">QR코드 대신 쿠폰 코드를 직접 입력하세요</p>
            <div class="mb-3">
                <input type="text" class="form-control" id="manualCouponCode" placeholder="쿠폰 코드를 입력하세요 (예: TEST10)" maxlength="50">
            </div>
            <div class="mb-3">
                <select class="form-select" id="manualDiscountType">
                    <option value="percent">퍼센트 할인 (%)</option>
                    <option value="fixed">고정 금액 할인 (원)</option>
                </select>
            </div>
            <div class="mb-3">
                <input type="number" class="form-control" id="manualDiscountValue" placeholder="할인 값" min="1" max="100">
            </div>
            <div class="mt-3">
                <button class="btn btn-success" onclick="applyManualCoupon()">
                    <i class="fas fa-check me-1"></i>쿠폰 적용
                </button>
                <button class="btn btn-secondary ms-2" onclick="retryCameraAccess()">
                    <i class="fas fa-camera me-1"></i>카메라로 돌아가기
                </button>
            </div>
        </div>
    `;
}

// 수동 쿠폰 적용
function applyManualCoupon() {
    const code = document.getElementById('manualCouponCode').value.trim();
    const discountType = document.getElementById('manualDiscountType').value;
    const discountValue = parseInt(document.getElementById('manualDiscountValue').value);
    
    if (!code || !discountValue) {
        alert('쿠폰 코드와 할인 값을 모두 입력해주세요.');
        return;
    }
    
    // 쿠폰 데이터 생성
    const couponData = {
        type: 'coupon',
        code: code,
        discount: discountValue,
        discountType: discountType,
        description: '수동 입력 쿠폰',
        createdAt: new Date().toISOString()
    };
    
    // 쿠폰 적용
    currentCoupon = {
        code: couponData.code,
        discount: couponData.discount,
        type: couponData.discountType,
        description: couponData.description
    };
    
    updateCartDisplay();
    closeQRScanner();
    
    // 성공 메시지
    showToast(`쿠폰이 적용되었습니다! ${discountValue}${discountType === 'fixed' ? '원' : '%'} 할인`, 'success');
}

// QR코드 스캔 중지
function stopQRScanner() {
    if (qrStream) {
        qrStream.getTracks().forEach(track => track.stop());
        qrStream = null;
    }
    const video = document.getElementById('qrVideo');
    video.srcObject = null;
}

// 쿠폰 취소
function cancelCoupon() {
    if (confirm('적용된 쿠폰을 취소하시겠습니까?')) {
        currentCoupon = null;
        updateCartDisplay();
        showToast('쿠폰이 취소되었습니다.', 'info');
    }
}

// QR코드 처리
function processQRCode(qrData) {
    try {
        const couponData = JSON.parse(qrData);
        
        if (couponData.type === 'coupon' && couponData.discount) {
            // 쿠폰 적용
            currentCoupon = {
                code: couponData.code || 'QR쿠폰',
                discount: couponData.discount,
                type: couponData.discountType || 'percent', // percent 또는 fixed
                description: couponData.description || `${couponData.discount}${couponData.discountType === 'fixed' ? '원' : '%'} 할인 쿠폰`
            };
            
            updateCartDisplay();
            
            // 성공 메시지
            showToast(`쿠폰이 적용되었습니다! ${couponData.discount}${couponData.discountType === 'fixed' ? '원' : '%'} 할인`, 'success');
            
        } else {
            showToast('유효하지 않은 쿠폰입니다.', 'error');
        }
        
    } catch (error) {
        console.error('QR코드 파싱 실패:', error);
        showToast('올바르지 않은 QR코드입니다.', 'error');
    }
}

// 이벤트 모달 열기
function openEventModal() {
    const modal = new bootstrap.Modal(document.getElementById('eventModal'));
    modal.show();
    
    // 모달이 열리면 QR코드 생성
    generateEventQRCode();
}

// 이벤트 모달 닫기
function closeEventModal() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('eventModal'));
    if (modal) {
        modal.hide();
    }
}

// 이벤트 QR코드 생성
function generateEventQRCode() {
    const qrContainer = document.getElementById('eventQRCode');
    
    // 기존 QR코드 제거
    qrContainer.innerHTML = '<i class="fas fa-spinner fa-spin fa-4x text-muted"></i>';
    
    // 서버에서 QR코드 생성 요청
    fetch('/generate-event-qr')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                qrContainer.innerHTML = `<img src="${data.qr_code}" alt="이벤트 QR코드" style="width: 100%; height: 100%; border-radius: 12px;">`;
            } else {
                console.error('이벤트 QR코드 생성 실패:', data.error);
                qrContainer.innerHTML = '<i class="fas fa-qrcode fa-4x text-muted"></i>';
            }
        })
        .catch(error => {
            console.error('이벤트 QR코드 생성 오류:', error);
            qrContainer.innerHTML = '<i class="fas fa-qrcode fa-4x text-muted"></i>';
        });
}

// 토스트 메시지 표시
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white border-0 position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999;';
    
    if (type === 'success') {
        toast.classList.add('bg-success');
    } else if (type === 'error') {
        toast.classList.add('bg-danger');
    } else {
        toast.classList.add('bg-info');
    }
    
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    document.body.appendChild(toast);
    
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    setTimeout(() => {
        if (toast.parentElement) {
            toast.remove();
        }
    }, 3000);
}

// 커스텀 결제 버튼 활성화/비활성화
function updateCustomPayButton() {
    const btn = document.getElementById('custompay-btn');
    if (Object.keys(cart).length === 0) {
        btn.disabled = true;
    } else {
        btn.disabled = false;
    }
}

// 커스텀 결제 버튼 이벤트 및 모달 관련 코드 복구
function openCustomPayModal() {
    // 모달 열기
    const modal = new bootstrap.Modal(document.getElementById('custompayModal'));
    modal.show();
    // QR코드 영역 초기화
    document.getElementById('custompay-qr').innerHTML = '<i class="fas fa-spinner fa-spin fa-3x text-muted"></i>';
    document.getElementById('custompay-status').textContent = '';
    // 결제 요청
    fetch('/custompay/request', { method: 'POST' })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                document.getElementById('custompay-qr').innerHTML = `<img src="${data.qr_code}" alt="QR코드" style="width:220px; height:220px;">`;
                // 결제 상태 polling 시작
                startCustomPayPolling(data.order_id, modal);
            } else {
                document.getElementById('custompay-qr').innerHTML = '<div class="text-danger">QR코드 생성 실패</div>';
            }
        })
        .catch(() => {
            document.getElementById('custompay-qr').innerHTML = '<div class="text-danger">서버 오류</div>';
        });
}

function startCustomPayPolling(orderId, modal) {
    if (custompayPolling) clearInterval(custompayPolling);
    let statusDiv = document.getElementById('custompay-status');
    custompayPolling = setInterval(() => {
        fetch(`/custompay/status/${orderId}`)
            .then(res => res.json())
            .then(data => {
                if (data.status === 'completed') {
                    clearInterval(custompayPolling);
                    modal.hide();
                    showPaymentResult(true, 'QR코드 결제가 완료되었습니다.', data.order_id);
                    clearCart();
                }
            });
    }, 1200);
}
</script>
{% endblock %} 