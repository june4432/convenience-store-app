{% extends "base.html" %}

{% block title %}ê²°ì œí•˜ê¸°{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">ì£¼ë¬¸ ìƒí’ˆ</h5>
                </div>
                <div class="card-body">
                    {% for item in cart_items %}
                    <div class="row align-items-center mb-3 pb-3 border-bottom">
                        <div class="col-md-2 text-center">
                            <i class="fas fa-box fa-2x text-muted"></i>
                        </div>
                        <div class="col-md-4">
                            <h6 class="mb-1">{{ item.product.name }}</h6>
                            <small class="text-muted">{{ item.product.description }}</small>
                        </div>
                        <div class="col-md-2 text-center">
                            <span class="text-success fw-bold">â‚©{{ "{:,}".format(item.product.price) }}</span>
                        </div>
                        <div class="col-md-2 text-center">
                            <span class="badge bg-secondary">{{ item.quantity }}ê°œ</span>
                        </div>
                        <div class="col-md-2 text-center">
                            <span class="text-success fw-bold">â‚©{{ "{:,}".format(item.total) }}</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">ê²°ì œ ì •ë³´</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-3">
                        <span>ì´ ìƒí’ˆ ìˆ˜:</span>
                        <span class="fw-bold">{{ cart_items|length }}ê°œ</span>
                    </div>
                    <div class="d-flex justify-content-between mb-3">
                        <span>ì´ ìˆ˜ëŸ‰:</span>
                        <span class="fw-bold">
                            {% set total_quantity = 0 %}
                            {% for item in cart_items %}
                                {% set total_quantity = total_quantity + item.quantity %}
                            {% endfor %}
                            {{ total_quantity }}ê°œ
                        </span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between mb-3">
                        <span class="h5">ì´ ê¸ˆì•¡:</span>
                        <span class="h5 text-success fw-bold">â‚©{{ "{:,}".format(total) }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mt-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">ê²°ì œ ì •ë³´</h5>
                </div>
                <div class="card-body">
                    <p class="mb-3">ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ í† ìŠ¤í˜ì´ë¨¼ì¸  ê²°ì œì°½ì´ ì—´ë¦½ë‹ˆë‹¤.</p>
                    <p class="mb-3">ê²°ì œì°½ì—ì„œ ë‹¤ì–‘í•œ ê²°ì œ ìˆ˜ë‹¨ì„ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:</p>
                    <ul class="mb-3">
                        <li>ğŸ’³ <strong>ì¹´ë“œ ê²°ì œ</strong>: ì‹ ìš©ì¹´ë“œ, ì²´í¬ì¹´ë“œ</li>
                        <li>ğŸ“± <strong>ê°„í¸ê²°ì œ</strong>: í† ìŠ¤í˜ì´, ë„¤ì´ë²„í˜ì´, ì¹´ì¹´ì˜¤í˜ì´, í˜ì´ì½” ë“±</li>
                        <li>ğŸ¦ <strong>ê³„ì¢Œì´ì²´</strong>: í€µê³„ì¢Œì´ì²´</li>
                        <li>ğŸ’° <strong>ê°€ìƒê³„ì¢Œ</strong>: ë¬´í†µì¥ì…ê¸ˆ</li>
                        <li>ğŸ“ <strong>íœ´ëŒ€í° ê²°ì œ</strong>: ì†Œì•¡ê²°ì œ</li>
                        <li>ğŸ« <strong>ìƒí’ˆê¶Œ</strong>: ë¬¸í™”ìƒí’ˆê¶Œ, ë„ì„œë¬¸í™”ìƒí’ˆê¶Œ, ê²Œì„ë¬¸í™”ìƒí’ˆê¶Œ</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">ì´ìš©ì•½ê´€</h5>
                </div>
                <div class="card-body">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="agreement-check" required>
                        <label class="form-check-label" for="agreement-check">
                            <small>ê²°ì œ ì§„í–‰ ì‹œ <a href="#" target="_blank">ì´ìš©ì•½ê´€</a>ì— ë™ì˜í•˜ëŠ” ê²ƒìœ¼ë¡œ ê°„ì£¼ë©ë‹ˆë‹¤.</small>
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mt-4">
        <div class="col text-center">
            <button id="payment-button" class="btn btn-success btn-lg" disabled>
                <i class="fas fa-credit-card"></i> ê²°ì œí•˜ê¸°
            </button>
            <a href="{{ url_for('cart') }}" class="btn btn-outline-secondary btn-lg ms-2">
                <i class="fas fa-arrow-left"></i> ì¥ë°”êµ¬ë‹ˆë¡œ ëŒì•„ê°€ê¸°
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- í† ìŠ¤í˜ì´ë¨¼ì¸  SDK -->
<script src="https://js.tosspayments.com/v2/standard"></script>

<script>
    // ì „ì—­ ë³€ìˆ˜ë¡œ payment ì €ì¥
    let globalPayment = null;
    
    document.addEventListener('DOMContentLoaded', function() {
        main();
    });
    
    async function main() {
        const button = document.getElementById("payment-button");
        
        // í† ìŠ¤í˜ì´ë¨¼ì¸  ì´ˆê¸°í™” (ê²°ì œì°½ SDK ì‚¬ìš©)
        const clientKey = "{{ client_key }}";
        const customerKey = "JuNm6zJ0Afr7xUwStZAwn";
        const tossPayments = TossPayments(clientKey);
        
        // ê²°ì œì°½ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
        const payment = tossPayments.payment({ customerKey });
        
        // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
        globalPayment = payment;
        
        // ê²°ì œí•˜ê¸° ë²„íŠ¼ í™œì„±í™”
        button.disabled = false;
        
        // ê²°ì œí•˜ê¸° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        button.addEventListener("click", async function() {
            // ì•½ê´€ ë™ì˜ í™•ì¸
            const agreementCheck = document.getElementById('agreement-check');
            if (!agreementCheck.checked) {
                alert('ì´ìš©ì•½ê´€ì— ë™ì˜í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // ê³ ê° ì •ë³´ ì…ë ¥ ëª¨ë‹¬ í‘œì‹œ
            showCustomerInfoModal();
        });
    }
    
    function showCustomerInfoModal() {
        const modalHtml = `
            <div class="modal fade" id="customerInfoModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">ê³ ê° ì •ë³´ ì…ë ¥</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="customerForm">
                                <div class="mb-3">
                                    <label for="customer_name" class="form-label">ì´ë¦„ *</label>
                                    <input type="text" class="form-control" id="customer_name" name="customer_name" required>
                                </div>
                                <div class="mb-3">
                                    <label for="customer_phone" class="form-label">ì „í™”ë²ˆí˜¸ *</label>
                                    <input type="tel" class="form-control" id="customer_phone" name="customer_phone" required>
                                </div>
                                <div class="mb-3">
                                    <label for="customer_email" class="form-label">ì´ë©”ì¼</label>
                                    <input type="email" class="form-control" id="customer_email" name="customer_email">
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                            <button type="button" class="btn btn-primary" onclick="requestPayment()">ê²°ì œ ì§„í–‰</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // ê¸°ì¡´ ëª¨ë‹¬ ì œê±°
        const existingModal = document.getElementById('customerInfoModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // ìƒˆ ëª¨ë‹¬ ì¶”ê°€
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // ëª¨ë‹¬ í‘œì‹œ
        const modal = new bootstrap.Modal(document.getElementById('customerInfoModal'));
        modal.show();
    }
    
    function requestPayment() {
        if (!globalPayment) {
            alert('ê²°ì œ ëª¨ë“ˆì´ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            return;
        }
        
        const form = document.getElementById('customerForm');
        const formData = new FormData(form);
        
        // ê²°ì œ ìš”ì²­
        fetch('/payment/request', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // ê²°ì œì°½ ì—´ê¸° (ê²°ì œì°½ SDK ì‚¬ìš©)
                globalPayment.requestPayment({
                    method: "CARD", // ì¹´ë“œ ë° ê°„í¸ê²°ì œ
                    amount: {
                        currency: "KRW",
                        value: data.payment_data.amount.value
                    },
                    orderId: data.payment_data.orderId,
                    orderName: data.payment_data.orderName,
                    customerName: data.payment_data.customerName,
                    customerEmail: data.payment_data.customerEmail,
                    successUrl: data.payment_data.successUrl,
                    failUrl: data.payment_data.failUrl,
                    // ì¹´ë“œ ê²°ì œì— í•„ìš”í•œ ì •ë³´
                    card: {
                        useEscrow: false,
                        flowMode: "DEFAULT", // í†µí•©ê²°ì œì°½ ì—¬ëŠ” ì˜µì…˜
                        useCardPoint: false,
                        useAppCardOnly: false,
                    },
                });
                
                // ëª¨ë‹¬ ë‹«ê¸°
                const modal = bootstrap.Modal.getInstance(document.getElementById('customerInfoModal'));
                modal.hide();
            } else {
                alert('ê²°ì œ ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('ê²°ì œ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
    }
</script>
{% endblock %} 