{% extends "base.html" %}

{% block title %}결제하기{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">주문 상품</h5>
                </div>
                <div class="card-body">
                    {% for item in cart_items %}
                    <div class="row align-items-center mb-3 pb-3 border-bottom">
                        <div class="col-md-2 text-center">
                            <i class="fas fa-box fa-2x text-muted"></i>
                        </div>
                        <div class="col-md-4">
                            <h6 class="mb-1">{{ item.product.name }}</h6>
                            <small class="text-muted">{{ item.product.description }}</small>
                        </div>
                        <div class="col-md-2 text-center">
                            <span class="text-success fw-bold">₩{{ "{:,}".format(item.product.price) }}</span>
                        </div>
                        <div class="col-md-2 text-center">
                            <span class="badge bg-secondary">{{ item.quantity }}개</span>
                        </div>
                        <div class="col-md-2 text-center">
                            <span class="text-success fw-bold">₩{{ "{:,}".format(item.total) }}</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">결제 정보</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-3">
                        <span>총 상품 수:</span>
                        <span class="fw-bold">{{ cart_items|length }}개</span>
                    </div>
                    <div class="d-flex justify-content-between mb-3">
                        <span>총 수량:</span>
                        <span class="fw-bold">
                            {% set total_quantity = 0 %}
                            {% for item in cart_items %}
                                {% set total_quantity = total_quantity + item.quantity %}
                            {% endfor %}
                            {{ total_quantity }}개
                        </span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between mb-3">
                        <span class="h5">총 금액:</span>
                        <span class="h5 text-success fw-bold">₩{{ "{:,}".format(total) }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mt-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">결제 정보</h5>
                </div>
                <div class="card-body">
                    <p class="mb-3">아래 버튼을 클릭하면 토스페이먼츠 결제창이 열립니다.</p>
                    <p class="mb-3">결제창에서 다양한 결제 수단을 선택할 수 있습니다:</p>
                    <ul class="mb-3">
                        <li>💳 <strong>카드 결제</strong>: 신용카드, 체크카드</li>
                        <li>📱 <strong>간편결제</strong>: 토스페이, 네이버페이, 카카오페이, 페이코 등</li>
                        <li>🏦 <strong>계좌이체</strong>: 퀵계좌이체</li>
                        <li>💰 <strong>가상계좌</strong>: 무통장입금</li>
                        <li>📞 <strong>휴대폰 결제</strong>: 소액결제</li>
                        <li>🎫 <strong>상품권</strong>: 문화상품권, 도서문화상품권, 게임문화상품권</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">이용약관</h5>
                </div>
                <div class="card-body">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="agreement-check" required>
                        <label class="form-check-label" for="agreement-check">
                            <small>결제 진행 시 <a href="#" target="_blank">이용약관</a>에 동의하는 것으로 간주됩니다.</small>
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mt-4">
        <div class="col text-center">
            <button id="payment-button" class="btn btn-success btn-lg" disabled>
                <i class="fas fa-credit-card"></i> 결제하기
            </button>
            <a href="{{ url_for('cart') }}" class="btn btn-outline-secondary btn-lg ms-2">
                <i class="fas fa-arrow-left"></i> 장바구니로 돌아가기
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- 토스페이먼츠 SDK -->
<script src="https://js.tosspayments.com/v2/standard"></script>

<script>
    // 전역 변수로 payment 저장
    let globalPayment = null;
    
    document.addEventListener('DOMContentLoaded', function() {
        main();
    });
    
    async function main() {
        const button = document.getElementById("payment-button");
        
        // 토스페이먼츠 초기화 (결제창 SDK 사용)
        const clientKey = "{{ client_key }}";
        const customerKey = "JuNm6zJ0Afr7xUwStZAwn";
        const tossPayments = TossPayments(clientKey);
        
        // 결제창 인스턴스 생성
        const payment = tossPayments.payment({ customerKey });
        
        // 전역 변수에 저장
        globalPayment = payment;
        
        // 결제하기 버튼 활성화
        button.disabled = false;
        
        // 결제하기 버튼 클릭 이벤트
        button.addEventListener("click", async function() {
            // 약관 동의 확인
            const agreementCheck = document.getElementById('agreement-check');
            if (!agreementCheck.checked) {
                alert('이용약관에 동의해주세요.');
                return;
            }
            
            // 고객 정보 입력 모달 표시
            showCustomerInfoModal();
        });
    }
    
    function showCustomerInfoModal() {
        const modalHtml = `
            <div class="modal fade" id="customerInfoModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">고객 정보 입력</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="customerForm">
                                <div class="mb-3">
                                    <label for="customer_name" class="form-label">이름 *</label>
                                    <input type="text" class="form-control" id="customer_name" name="customer_name" required>
                                </div>
                                <div class="mb-3">
                                    <label for="customer_phone" class="form-label">전화번호 *</label>
                                    <input type="tel" class="form-control" id="customer_phone" name="customer_phone" required>
                                </div>
                                <div class="mb-3">
                                    <label for="customer_email" class="form-label">이메일</label>
                                    <input type="email" class="form-control" id="customer_email" name="customer_email">
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                            <button type="button" class="btn btn-primary" onclick="requestPayment()">결제 진행</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // 기존 모달 제거
        const existingModal = document.getElementById('customerInfoModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // 새 모달 추가
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // 모달 표시
        const modal = new bootstrap.Modal(document.getElementById('customerInfoModal'));
        modal.show();
    }
    
    function requestPayment() {
        if (!globalPayment) {
            alert('결제 모듈이 초기화되지 않았습니다.');
            return;
        }
        
        const form = document.getElementById('customerForm');
        const formData = new FormData(form);
        
        // 결제 요청
        fetch('/payment/request', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // 결제창 열기 (결제창 SDK 사용)
                globalPayment.requestPayment({
                    method: "CARD", // 카드 및 간편결제
                    amount: {
                        currency: "KRW",
                        value: data.payment_data.amount.value
                    },
                    orderId: data.payment_data.orderId,
                    orderName: data.payment_data.orderName,
                    customerName: data.payment_data.customerName,
                    customerEmail: data.payment_data.customerEmail,
                    successUrl: data.payment_data.successUrl,
                    failUrl: data.payment_data.failUrl,
                    // 카드 결제에 필요한 정보
                    card: {
                        useEscrow: false,
                        flowMode: "DEFAULT", // 통합결제창 여는 옵션
                        useCardPoint: false,
                        useAppCardOnly: false,
                    },
                });
                
                // 모달 닫기
                const modal = bootstrap.Modal.getInstance(document.getElementById('customerInfoModal'));
                modal.hide();
            } else {
                alert('결제 요청에 실패했습니다: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('결제 요청 중 오류가 발생했습니다.');
        });
    }
</script>
{% endblock %} 